# ARP(Address Resolution Protocol)
> **IP 주소**를 **물리적 네트워크 주소(MAC 주소)** 로 매핑하기 위해 사용하는 프로토콜

## MAC 주소란?
> 데이터 링크 계층에서 통신하기 위한 48비트 하드웨어 고유 식별 주소
- 네트워크 인터페이스 컨트롤러(NIC)에 할당됨
    - **NIC** : 컴퓨터를 네트워크에 연결하여 통신하기 위해 사용하는 **하드웨어** 장치
- 네트워크 통신을 위해서는 **IP주소**뿐만 아니라 **MAC주소**도 필요함

## 이제 데이터를 보내볼까?
> 목적지의 IP주소는 알지만 MAC주소는 모르는 상황

1. 먼저 ARP 캐시를 확인한다.
    - 만약 ARP 캐시에 필요한 MAC주소가 있으면 사용하면 된다.
2. 만약 ARP 캐시에서 찾지 못했을 경우, ARP를 통해 MAC주소를 알아낸다.

## ARP 패킷 형식

|Sender HW 주소|Sender protocol 주소|Target HW 주소|Target protocol 주소|
|:---:|:---:|:---:|:---:|
|84-12-e3-66-a0-59|111.111.111.112|**?????**|111.111.111.111|

## ARP 방식

- ARP 요청과 ARP 응답
    - **ARP 요청** : **브로드캐스트**로 목적지 IP에 해당하는 MAC주소를 달라고 요청
    - **ARP 응답** : ARP 요청에 있는 IP가 자신의 IP주소라면 자신의 MAC주소를 담아 요청한 쪽에 **유니캐스트**로 응답

- 브로드캐스트와 유니캐스트
    - **브로드 캐스트** : 자신이 속해있는 네트워크 전체를 대상으로 패킷을 전송하는 **일대다** 통신 방식
    - **유니캐스트** : 하나의 네트워크 목적지를 대상으로 패킷을 전송하는 **일대일** 통신 방식
    ---
1. 브로드캐스트로 ARP 요청을 보냄
2. 타겟이 맞는 당사자는 Sender의 IP-MAC 주소 매핑을 자신의 ARP 캐시에 저장
    - 타겟이 아닌 나머지는 Sender의 IP-MAC 주소 매핑이 자신의 ARP 캐시에 있으면 업데이트 후 무시 (❗️**ARP 캐시 업데이트 규칙**❗️)
3. 타겟이 맞는 당사자는 자신의 MAC주소를 담아 ARP 응답을 유니캐스트로 보냄
4. 요청한 쪽은 Target의 IP-MAC 주소 매핑을 자신의 ARP 캐시에 저장 후 다음 작업 시작

## ⚠️특수한 ARP 상황들

### Gratuitous ARP
> 자신의 IP주소를 타겟으로 하는 ARP 요청
- 자신의 바뀐 MAC주소를 다른 인터페이스들에게 업데이트시키고 싶을 때
    - NIC교체, 백업서버 자동 교체 등..
- MAC주소는 동일한데 IP주소가 바뀌는 경우
    - 무선 랜 변경 시 새로운 IP가 할당되는 경우
- IP 주소 중복 할당 탐지를 위해서(DAD: Duplicate Address Detection)
    - DAD의 문제점 :<br/>실수로 중복된 IP를 수동 설정한 컴퓨터<br/>-> DAD를 위해 GARP를 보냄<br/>-> 잘못된 매핑이 네트워크의 다른 컴퓨터에 업데이트<br/>-> 고치기 전까지 잘못된 정보 가지고 있음<br/>-> GARP 대신 **ACD** 사용

### ACD(Address Conflict Detection)
> GARP(ACD의 Announcement 패킷)을 보내기 전, ACD의 ARP Probe 패킷을 보내 먼저 확인하는 방법

- Probe 패킷 : Source Protocol 주소를 0.0.0.0으로 설정해서 보냄
    - 이를 통해 자신과 같은 IP의 중복을 확인하면서, ARP 업데이트 규칙을 방지
- Announcement 패킷 : GARP와 동일

### Proxy ARP
> 네트워크가 변경되었을 때, 동일한 IP를 사용할 경우 이전 네트워크에서 ARP요청을 HA(home agent)라고 하는 컴퓨터가 대신 응답함
- 쉽게 말해서 **전달자** 역할을 해주는 셈

### Directed ARP
> 유니캐스트로 보내지는 ARP 요청
- ARP 캐시에 저장된는 매핑 정보는 유효 수명이 존재
- 자신의 ARP 캐시에 있는 수명이 다 된 매핑 정보를 지우지 않기 위해, 그 인터페이스에게 다시 매핑이 유효한지 물어볼 때 사용 (**유효 수명 연장**)

## 😈ARP spoofing
> GARP 또는 ACD Announcement를 통해 의도적으로 잘못된 매핑 정보를 업데이트시키는 공격 기법
- 잘못된 매핑 정보를 업데이트시켜서 중간에 패킷을 가로채 볼 수 있음

### 🛡️방어 방법
- 정적 ARP 엔트리 사용
    - 정적 ARP 엔트리는 업데이트가 되지 않음
- 패킷 감지 프로그램을 사용해 ARP 패킷 확인
- 모든 매핑에 대해 주기적으로 ARP 요청 보내기
    - 정상적 응답이 먼저 올 수도 있고, 변조된 응답이 먼저 올 수도 있음
    - 사용자 입장에서는 인터넷이 되었다, 안 되었다하는 느낌

# 예상 질문
<details>
<summary>
ARP가 뭔가요?</summary>
<div markdown="1">
<b>IP주소와 매핑되는 MAC주소를 얻기 위해 사용하는 프로토콜입니다.</b>
</div>
</details>

# 레퍼런스
- [ARP 프로토콜 10분 테크톡](https://www.youtube.com/watch?v=KMEPEdsK71I)
- [DNS와 ARP 10분 테크톡](https://www.youtube.com/watch?v=DfNGidKhY6U)